<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà Google Drive</title>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery-bundle.min.css" />
  <style>
    body { font-family: 'Sarabun', sans-serif; background: #e8ecf2; text-align: center; padding: 40px; }
    .container { background: #fff; padding: 25px; border-radius: 15px; max-width: 800px; margin: auto; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    input[type="text"] { width: 90%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 2px solid #ccc; font-size: 16px; }
    button { padding: 10px 20px; margin: 10px; font-size: 16px; border: none; border-radius: 8px; cursor: pointer; }
    .btn-submit { background-color: #d84433; color: white; }
    .preview-img { width: 100px; border-radius: 8px; }
    .footer { margin-top: 30px; font-size: 14px; color: #555; }
    #categoryGallery h4 { margin-top: 30px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å Google Drive</h2>
    <form id="driveForm">
      <input type="text" id="driveUrl" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå Google Drive ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà">
      <br>
      <button type="submit" class="btn-submit">‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
    </form>
  </div>

  <div class="container" id="galleryContainer" style="display:none;">
    <h3>‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ‡πà‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3>
    <input type="text" id="searchGallery" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û..." style="padding: 10px; width: 90%; margin: 10px auto; border-radius: 8px; border: 1px solid #ccc; font-size: 16px;">
    <div id="categoryGallery"></div>
  </div>

  <div class="footer">
    ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏Ñ‡∏£‡∏π‡∏ô‡∏¥‡∏î ‡∏®‡∏¥‡∏©‡∏¢‡πå‡∏´‡∏•‡∏ß‡∏á‡∏û‡πà‡∏≠‡πÄ‡∏™‡∏∑‡∏≠<br>
    ‡∏Ñ‡∏£‡∏π‡∏ô‡∏¥‡∏î‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠ <a href="tel:0892231515">089-223-1515</a>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/zoom/lg-zoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script>
  <script>
    let fileCache = [];
    let lastFolderId = null;

    document.getElementById("driveForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const folderUrl = document.getElementById("driveUrl").value.trim();
      const match = folderUrl.match(/[-\w]{25,}/);
      const folderId = match ? match[0] : null;
      if (!folderId) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");

      if (folderId !== lastFolderId) {
        fileCache = [];
        lastFolderId = folderId;
      }

      if (fileCache.length > 0) {
        renderGallery(fileCache);
        return;
      }

      const url = `https://script.google.com/macros/s/AKfycbyHSJTK8V8iTSwI7Dkf7GL25RnCA0VOduuZxACbNTi9olWpasiKYCwDkRHYEuylP86mvA/exec?folderId=${folderId}`;
      fetch(url)
        .then(res => res.json())
        .then(data => {
          fileCache = data.map(file => ({
            ...file,
            category: getFileCategory(file.type, file.name)
          }));
          renderGallery(fileCache);
        })
        .catch(err => {
          alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          console.error(err);
        });
    });

    function getFileCategory(type, name) {
      if (type.includes("image") || /\.(jpg|jpeg|png|gif)$/i.test(name)) return "image";
      if (type.includes("pdf")) return "pdf";
      if (type.includes("document") || /\.(docx?|txt)$/i.test(name)) return "doc";
      return "other";
    }

    function renderGallery(images) {
      const container = document.getElementById("categoryGallery");
      container.innerHTML = "";

      const categories = {
        activity: [], pdf: [], doc: [], other: []
      };

      images.forEach(file => {
        const cat = file.category;
        if (cat === "image") categories.activity.push(file);
        else if (cat === "pdf") categories.pdf.push(file);
        else if (cat === "doc") categories.doc.push(file);
        else categories.other.push(file);
      });

      function createGallerySection(title, list, galleryId) {
        if (list.length === 0) return;

        const section = document.createElement("div");
        section.innerHTML = `<h4>${title}</h4><div id="${galleryId}" class="lightgallery" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div>`;
        container.appendChild(section);

        const galEl = section.querySelector(`#${galleryId}`);
        list.forEach(file => {
          const fileId = file.url.match(/[-\w]{25,}/)?.[0] || "";
          const thumb = file.thumbnail || `https://drive.google.com/uc?export=view&id=${fileId}`;
          const a = document.createElement("a");
          a.href = thumb;
          a.setAttribute("data-lg-size", "1600-1067");
          a.setAttribute("data-sub-html", `<h4>${file.name}</h4><a href='${file.url}' target='_blank' download class='download-btn'>\u0e14\u0e32\u0e27\u0e19\u0e4c\u0e42\u0e2b\u0e25\u0e14</a>`);
          a.innerHTML = `<img src="${thumb}" alt="${file.name}" class="preview-img">`;
          galEl.appendChild(a);
        });

        lightGallery(galEl, {
          plugins: [lgZoom, lgThumbnail],
          speed: 400,
          download: false
        });
      }

      createGallerySection("\ud83d\udcf8 \u0e20\u0e32\u0e1e\u0e01\u0e34\u0e08\u0e01\u0e23\u0e23\u0e21", categories.activity, "gal-activity");
      createGallerySection("\ud83d\udcc4 PDF", categories.pdf, "gal-pdf");
      createGallerySection("\ud83d\udcdc \u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23", categories.doc, "gal-doc");
      createGallerySection("\ud83d\udce6 \u0e2d\u0e37\u0e48\u0e19 \u0e46", categories.other, "gal-other");

      document.getElementById("galleryContainer").style.display = "block";

      document.getElementById("searchGallery").addEventListener("input", function () {
        const keyword = this.value.toLowerCase();
        document.querySelectorAll("#categoryGallery a").forEach(el => {
          const match = el.getAttribute("data-sub-html")?.toLowerCase().includes(keyword);
          el.style.display = match ? "inline-block" : "none";
        });
      });
    }
  </script>
</body>
</html>
